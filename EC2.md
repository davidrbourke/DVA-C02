# EC2

## Basics

Elastic Compute - Infrastructure as a service

- VMs (EC2)
- Storing data on Virtual Drives (EBS)
- Distributing load balancing (ELB)
- Auto-scaling Groups (ASG)
- Bootstrapping - run scripts on start up, e.g. installing software. Create a Bash script in **EC2 User Data** to automate EC2 instance start up operations.

IP is dynamic by default. A new IP is generated for the VM between restarts.

## Types of instances

https://aws.amazon.com/ec2/instance-types/

### Naming convention

Example: M6.2xlarge

#### Explained

- Class, e.g. M
- Generation, e.g. 6
- Size, e.g. 2xlarge

### Classes

- General Purpose - balanced, e.g. web servers, diverse workloads (M class)
- Compute Optimized - e.g. gaming, machine learning, intensive CPU usage, etc. (C class)
- Memory Optimized - e.g. in-memory databases, etc. (R & X class)
- Storage Optimized - high frequency OLTP systems, cache for in-memory, data warehouses, etc. (I & D class)

## Firewalls

### Security Groups

Security Groups control traffic allowed in and out of EC2 instances.

- Only contains **allow** rules.
- Can reference by IP, or by other Security Groups.
- Regulate

  - Access to ports
  - Authorised IP ranges
  - Control of inbound network
  - Control of outbound network

- Can be attached to multiple instances
- Locked down to specific regions
- Live outside of the EC2, EC2 won't see blocked traffic

#### In Practice

- Maintain one separate security group for SSH access (best practice)
- Timeout errors - means security group blocked
- Connection refused, or other error - means application was reached but there is some issue.
- Referencing other security groups allows EC2 instances that share the same SG to communicate with each other.

Example

```
  Type: HTTP
  Protocol: TCP
  Port Range: 80
  Source: 0.0.0.0/0
  Description: ...
```

#### Common Ports

- SSH: 22
- FTP: 21
- SFTP: 22
- HTTP: 80
- HTTPS: 443
- RDP: 3389 (Remote Desktop for a Window instance)
- Network File System: 2049

## Connecting into EC2

On Linux, Mac, Windows 10+ use SSH.
Windows less than v10, use Putty.
Web Browser - EC2 Instance Connect - Only works with Amazon Linux 2 (OS on VM). A .pem file will be automatically created. Existing Security Group rules still apply.

### On Windows connect via SSH

1. Be in the same directory as the .pem file downloaded when setting up the EC2 instance.
2. Ensure there are no spaces in the .pem file name.
3. Enter command: `ssh -i EC2Tutorial.pem ec2-user@3.252.149.106`
   1. ec2-user is the user generated by AL2.
   2. Enter the public IP of the EC2 instance.
4. Issues
   1. Ensure your user is the owner of the .pem file
   2. Remove all inherited permissions, and ensure only you are the principal of the .pem file.

## EC2 Instance Roles

SSH into EC2 and run `aws iam list-users`. This will return `Unable to locate credentials. You can configure credentials by running "aws configure".`  
**Do not run aws configure**, this would give anyone who accesses the EC2 instance permissions with your credentials. You need to assign a role to the EC2 in the AWS Console. Go to the EC2 Instance options `Actions` > `Security` > `Modify IAM role`. Here you can assign the role with permissions.  
For this a role was create in IAM for EC2 called DemoRoleForEC2 and assigned to the EC2 with a policy of **IAMReadOnlyAccess**. Output of `aws iam list-users` is now:

```
{
    "Users": [
        {
            "Path": "/",
            "UserName": "-",
            "UserId": "-",
            "Arn": "-",
            "CreateDate": "2025-06-16T07:33:07+00:00",
            "PasswordLastUsed": "2025-08-05T07:11:07+00:00"
        }
    ]
}
```

## EC2 Instance Purchasing Options

### On-Demand Instances

- Purpose: For short-term uninterrupted unpredictable workloads
- Cost: highest cost
- Details: Predictable pricing.
- Payment: Billing per second, after the 1st minute, no upfront payment.
- Reservation period: None

### Reserved Instances (1 & 3 years)

- Purpose: Long workloads with steady state applications, e.g. a database.
- Cost: Up to 72% discount compared to On-demand
- Details:
  - Reserve specific instance attributes; instance type, region, tenancy, OS.
  - Scope is Region or Availability Zone (AZ).
  - Buy or sell in the Reserved Instance Marketplace
- Reservation period: 1 or 3 years (longer is greater discount)
- Payment: No upfront, partial upfront, all upfront (more upfront is larger discount)

#### Convertable Reserved Instances

Allows changing the instance specification; instance type, family, OS, scope, and tenancy.

- Cost: Up to 66% discount

### Savings Plans (1 & 3 years)

- Purpose: Long workloads, commitment to amount of usage.
- Cost: Up to 72% discount compared to On-demand
  - Usage above the savings plan range is billed at the On-Demand price.
- Details:
  - Fixed to a specific instance family and AWS region, e.g. M5 us-east.
  - Flexible configuration on instance size, OS, tenancy (host, dedicated, default).
- Reservation period: 1 or 3 years, but **commiting to a certain type of usage, e.g. cost per hour**.

### Spot Instances

- Purpose: Short workloads, resilient to failure, e.g. batch jobs, image processing, distributed workloads, etc.
- Details:
  - You define a maximum price you will pay for the spot instances, if the spot price goes over it, then you lose your instance.
  - These are **not** suitable for databases, or critical applications.
- Cost: Up to 90% discount compared to On-Demand (cheapest).

### Dedicated Hosts

- Purpose: Reserve entire physical server and control instance placement. E.g.,
  - When you have your own licenses per-socket/core/vm.
  - Where regulatory compliancy requires a dedicated server.
- Details:
  - Allows you to control instance placement
- Cost: Most expensive
- Reservation period:
  - On-Demand - pay per-second
  - Reserved - 1 or 3 years (No upfront, partial upfront, all upfront).

### Dedicated Instances

- Purpose: Instances run on hardware dedicated to you
- Details:
  - May share hardware with other instances in same account
  - No control over instance placement (can move after stopping and starting)
- Reservation period:
  - On-Demand - pay per-second
  - Spot instances - pay per-hour - same pricing as standard spot instances.
  - Reserved - 1 or 3 years (No upfront, partial upfront, all upfront).

### Dedicated Hosts vs Dedicated Instances

Think of Dedicated Instances as having a dedicated parking spot in a shared parking garage. You have exclusive use of the spot, but you don't control which specific garage you're in.
Think of Dedicated Hosts as having an entire dedicated parking garage. You have complete control over the garage and its resources.

### Capacity Reservations

- Purpose: Short term uninterrupted workloads that need to be in a specific AZ.
- Details:
  - Reserve capacity in a specific AZ for any duration.
  - You have access to it whenever you need it.
- Reservation period: None - you can cancel at any time
- Cost: No discounts, charged at On-Demand pricing whether you are using the instance or not.
  - Combine with Regional Reserved Instances and Savings Plans to benefit from discounts.

## Analogy of Hotels reservation

1. On-Demand: staying at hotel whenever required with no pre-planning and paying full price.
2. Reserved: planning ahead and staying for a long time, getting a discount for longer term fixed period pre-arranged booking (in a specific room type - unless using Convertable reserved).
3. Savings Plan: paying a certain amount per hour for a certain period and stay in any room type.
4. Spot instances: biding on empty rooms, highest bidder gets the room, can get ejected at any time if someone else will pay more.
5. Dedicated hosts: booking the entire hotel and having full access to the hotel.
6. Capacity reservations: booking a room for a fixed period at full price even if you don't stay there.

## Public IP Charges

### IPv4

1. In first 12 months, 750 hours free on EC2 instances of public IP.
2. Exceeding the 750 hours or 12 months, is charged at $0.005 per hour ($43.80 per year)
3. Using a Public IP in other services, e.g., a load balancer, has no free option.

A guide to investigating what services you have that are causing IPv4 charges: https://repost.aws/articles/ARknH_OR0cTvqoTfJrVGaB8A/why-am-i-seeing-charges-for-public-ipv4-addresses-when-i-am-under-the-aws-free-tier

Information about what Public IP you are using can be configured in the Amazon VPC IP Address Manager service (IPAM): https://eu-west-1.console.aws.amazon.com/ipam/home?region=eu-west-1#Home

### IPv6

IPv6 is free currently.
